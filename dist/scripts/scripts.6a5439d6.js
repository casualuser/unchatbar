angular.module("constants",[]).constant("LOCALSTORAGE",!0),angular.module("unchatbar",["constants","cgNotify","ngStorage","ui.router","ui.bootstrap","angularjs-dropdown-multiselect"]),angular.module("unchatbar").run(["$templateCache",function(a){"use strict";a.put("views/peer/connection-center.html",'<div class=panel-group role=tablist aria-multiselectable=true data-ng-init="setView(\'dashboard\')"><div class="panel panel-default"><div class=panel-heading role=tab><h4 class=panel-title><span data-ng-click="setView(\'dashboard\')">Dashboard {{panelInfo.dashboard || \'\'}}</span></h4></div><div class="panel-collapse collapse" data-ng-class="{in: showPanel === \'dashboard\'}" role=tabpanel aria-labelledby=headingOne><div class=panel-body>TODO DASHBOARD</div></div></div><div class="panel panel-default"><div class=panel-heading role=tab><h4 class=panel-title><span data-ng-click="setView(\'phoneBook\')">Phone book {{panelInfo.phoneBook || \'\'}}</span></h4></div><div class="panel-collapse collapse" data-ng-class="{in: showPanel === \'phoneBook\'}" role=tabpanel aria-labelledby=headingOne><div class=panel-body><phone-book-admin></phone-book-admin></div></div></div><div class="panel panel-default"><div class=panel-heading role=tab><div class=row><div class=col-md-3 data-ng-click="setView(\'chat\')"><h4 class=panel-title>Text chat</h4></div><div class=col-md-9><phone-book></phone-book></div></div></div><div class="panel-collapse collapse" data-ng-class="{in: showPanel === \'chat\'}" role=tabpanel aria-labelledby=headingOne><div class=panel-body><text-message-list></text-message-list></div></div></div><div class="panel panel-default"><div class=panel-heading role=tab><div class=row><div class=col-md-3 data-ng-click="setView(\'stream\')"><h4 class=panel-title>Audio/Video</h4></div><div class=col-md-9><phone-book-stream></phone-book-stream></div></div></div><div class="panel-collapse collapse" data-ng-class="{in: showPanel === \'stream\'}" role=tabpanel aria-labelledby=headingOne><div class=panel-body><stream></stream></div></div></div></div>'),a.put("views/peer/dialer.html",'<div ng-show=peerId><form class=form-inline><div class=form-group><div class=input-group><input class=form-control data-ng-model=connectId placeholder="client id"><div data-ng-click=connect() class=input-group-addon><i class="fa fa-check fa-1x"></i></div></div></div></form><hr></div>'),a.put("views/peer/layout/chat/content.html",'<div class="col-xs-12 col-sm-9"><div class=jumbotron><active-user></active-user></div><div class=row><div class="col-xs-12 col-lg-12"><h2>Video/Audio</h2><stream></stream></div></div><div class=row><div class="col-xs-12 col-lg-12"><h2>Chat</h2><text-message-list></text-message-list></div></div></div>'),a.put("views/peer/layout/chat/footer.html","<footer><p>&copy; Company 2014</p></footer>"),a.put("views/peer/layout/chat/header.html",'<nav class="navbar navbar-fixed-top navbar-inverse"><div class=container data-ng-init="isCollapse=false"><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-ng-click="isCollapse=!isCollapse" aria-expanded=false aria-controls=navbar><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><profile></profile></div><div id=navbar class="collapse navbar-collapse" data-ng-class="{\'in\' : isCollapse}"><ul class="nav navbar-nav"><li><a ui-sref-active=active ui-sref=chat.profile>Profile</a></li></ul></div></div></nav>'),a.put("views/peer/layout/chat/index.html",'<div data-ui-view=header></div><div class=container data-ng-init="offcanvas=false"><div class="row row-offcanvas row-offcanvas-left" data-ng-class="{\'active\': offcanvas}"><p class="pull-left visible-xs"><i data-ng-click="offcanvas=!offcanvas" class="fa fa-book fa-4x"></i></p><div data-ui-view=sidebar></div><div data-ui-view=content></div></div><hr></div>'),a.put("views/peer/layout/chat/sidebar.html",'<div class="col-xs-6 col-sm-3 sidebar-offcanvas active"><div class=list-group><phone-book></phone-book></div></div>'),a.put("views/peer/layout/login.html",'<div class=container data-ng-controller=broker><form class=form-signin><h2 class=form-signin-heading>Please sign in</h2><label for=peerId class=sr-only>your Phonenumber</label><input id=peerId class=form-control data-ng-model=peerId placeholder="your phone Number" required autofocus> <button class="btn btn-lg btn-primary btn-block" type=submit data-ng-click=login();>Sign in</button></form></div>'),a.put("views/peer/modal/streamOption.html",'<div class=modal-header><h3 class=modal-title>call option</h3></div><div class=modal-body><div class=row><div class="col-xs-6 text-left"><button type=button class="btn btn-default btn-lg" aria-label="Left Align" ng-click=videoCall()><i class="glyphicon glyphicon-facetime-video"></i>Video</button></div><div class="col-xs-6 text-right"><button type=button class="btn btn-default btn-lg" ng-click=audiCall() aria-label="Left Align" ng-click=videoCall()><i class="glyphicon glyphicon-earphone"></i>Audio</button></div></div></div>'),a.put("views/peer/phoneBook/active-user.html",'<div data-ng-init=getClientAndGroups()><div data-ng-show=selectedUser><i data-ng-click="offcanvas=!offcanvas" class="fa fa-user fa-4x"></i><p>{{clientMap[selectedUser].label}}</p><hr><div class="btn btn-success call" data-ng-click=streamToClient(selectedUser)><i class="fa fa-phone fa-3x"></i></div><div class="btn btn-success call" data-ng-click=removeClient(selectedUser)><i class="fa fa-trash fa-3x"></i></div></div><div data-ng-show=selectedGroup><i data-ng-click="offcanvas=!offcanvas" class="fa fa-users fa-4x"></i><p>{{groupMap[selectedGroup].label}}</p><hr><div class="btn btn-success call" data-ng-click=streamToGroup(selectedGroup)><i class="fa fa-phone fa-3x"></i></div><div class="btn btn-success call" data-ng-click=removeGroup(selectedGroup)><i class="fa fa-trash fa-3x"></i></div>{{}}<div class="btn btn-success call" ng-if="groupMap[selectedGroup].editable === true"><span ng-dropdown-multiselect="" extra-settings="{showCheckAll:false,showUncheckAll : false}" options=clientMap translation-texts="{buttonDefaultText: group.label,dynamicButtonTextSuffix: \'users in\'+ group.label}" selected-model=groupMap[selectedGroup].users></span></div></div></div>'),a.put("views/peer/phoneBook/addNewGroup.html",""),a.put("views/peer/phoneBook/book-admin.html",'<div data-ng-init="getClientAndGroups();bookShow = \'user\'"><div><div role=tabpanel><ul class="nav nav-tabs" role=tablist><li role=presentation ng-class="{\'active\' : bookShow === \'user\'}"><a data-ng-click="bookShow=\'user\'">User</a></li><li role=presentation ng-class="{\'active\' : bookShow === \'group\'}"><a data-ng-click="bookShow=\'group\'">groups</a></li><li role=presentation ng-class="{\'active\' : bookShow === \'group\'}"><dialer></dialer></li></ul></div><div class=tab-content><div role=tabpanel class=tab-pane ng-class="{\'active\' : bookShow === \'user\'}"><div ng-repeat="(peerId,connection) in clientList">{{getUserName(peerId)}} <i class="glyphicon glyphicon-trash" data-ng-click=removeClient(peerId)></i></div></div><div role=tabpanel class=tab-pane ng-class="{\'active\' : bookShow === \'group\'}"><br><input data-ng-model=newGroupName placeholder="create new group"> <span class="glyphicon glyphicon-ok" ng-click=createGroup()></span><br><h3>own Groups</h3><hr><div ng-repeat="(groupId,group) in groupMap"><div ng-if="group.editable === true"><span ng-dropdown-multiselect="" extra-settings="{showCheckAll:false,showUncheckAll : false}" options=clientMap translation-texts="{buttonDefaultText: group.label,dynamicButtonTextSuffix: \'users in\'+ group.label}" selected-model=group.users></span> <i class="glyphicon glyphicon-trash" data-ng-click=removeGroup(groupId)></i></div></div><br><h3>enter Groups</h3><hr><div ng-repeat="(groupId,group) in groupMap"><div ng-if="group.editable === false">{{group.label}} <i class="glyphicon glyphicon-trash" data-ng-click=removeGroup(groupId)></i> <i class="glyphicon glyphicon-arrow-down" ng-click="showUser=!showUser"></i><div ng-show=showUser><ul><li ng-repeat="user in group.users">{{getUserName(user.id)}}</li></ul></div></div></div></div></div></div></div>'),a.put("views/peer/phoneBook/book-stream.html",'<div data-ng-init=getClientAndGroups()><div class=btn-group dropdown><button type=button class="btn btn-default dropdown-toggle" dropdown-toggle>single Call</button><ul class=dropdown-menu><li ng-repeat="(peerId,connection) in clientMap"><a data-ng-click=streamToClient(peerId)>{{connection.label}}</a></li></ul></div><div class=btn-group dropdown><button type=button class="btn btn-default dropdown-toggle" dropdown-toggle>Conference</button><ul class=dropdown-menu><li ng-repeat="(peerId,connection) in clientMap"><a data-ng-click=streamToConference(peerId)>{{connection.label}}</a></li></ul></div></div>'),a.put("views/peer/phoneBook/book.html",'<div data-ng-init=init()><tabset justified=true><tab heading=user active=selectedUser><dialer></dialer><br><div ng-repeat="(peerId,connection) in clientMap"><a ui-sref-active=active ui-sref="chat.user({peerId: peerId})" class=list-group-item>{{connection.label}}</a></div></tab><tab heading=Groupps active=selectedGroup><div><form class=form-inline><div class=form-group><div class=input-group><input class=form-control data-ng-model=form.newGroupName placeholder="add new group"><div data-ng-click=createGroup() class=input-group-addon><i class="fa fa-check fa-1x"></i></div></div></div></form><hr></div><br><div ng-repeat="(groupId,group) in groupMap"><a ui-sref-active=active ui-sref="chat.group({groupId: groupId})" class=list-group-item>{{group.label}}</a></div></tab></tabset></div>'),a.put("views/peer/profile-admin.html",'<div class="col-xs-12 col-sm-9" data-ng-controller=profile data-ng-init=init()><form><div class=form-group><label for=profileLabel>Name</label><input required class=form-control id=profileLabel data-ng-model=profile.label placeholder="Enter our name"></div><button type=submit data-ng-click=update() class="btn btn-default">save</button></form></div>'),a.put("views/peer/profile.html","<div data-ng-init=init(); class=navbar-brand>{{peerId}}</div>"),a.put("views/peer/stream/client-stream.html",'<div>user : {{user.label}}<div ng-switch=streamType><div ng-switch-when=video><video-stream type={{type}} stream-id={{streamId}}></video-stream></div><div ng-switch-when=audio><i class="glyphicon glyphicon-volume-up"></i><audio-stream type={{type}} stream-id={{streamId}}></audio-stream></div><button ng-click=close() type=button class="btn btn-danger">hangup</button></div></div>'),a.put("views/peer/stream/stream-video.html","<video autoplay data-ng-show=isVisible width=200></video>"),a.put("views/peer/stream/stream.html",'<div><div data-ng-repeat="(streamId,stream) in streamConferenceMap"><client-stream stream-id={{streamId}} type=conference width=200></client-stream></div><br><hr><div data-ng-repeat="(streamId,stream) in streamMap"><client-stream stream-id={{streamId}} type=single width=200></client-stream></div><own-stream-video></own-stream-video></div>'),a.put("views/peer/stream/type/audio.html","<audio autoplay autoplay width=200></audio>"),a.put("views/peer/stream/type/video.html","<video autoplay autoplay width=200></video>"),a.put("views/peer/text-message-list.html","<div class=\"panel panel-default\" data-ng-init=init()><div class=panel-body><div ng-repeat=\"mess in messageList\"><p data-ng-class=\"{'text-left': mess.own === true,'text-right': mess.own === false}\"><span data-ng-show=mess.roomName>{{mess.roomName}}:</span> {{mess.own ? 'XX' + getProfileName(): getUserName(mess.user)}}</p><p class=triangle-right data-ng-class=\"{'left': mess.own === true,'right': mess.own === false}\">{{mess.text}}</p></div></div><div class=panel-footer data-ng-show=isRoomSelected><input data-ng-model=message placeholder=text class=form-control> <button data-ng-click=send() type=button class=\"btn btn-lg btn-primary btn-block\">send</button></div></div>")}]),angular.module("unchatbar").provider("Broker",function(){var a="",b="",c="",d=!1;this.setHost=function(b){a=b},this.setPort=function(a){b=a},this.setPath=function(a){c=a},this.setLocalStorage=function(){d=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","BrokerHeartbeat","Peer",function(e,f,g,h,i){var j={_storage:{peerId:""},init:function(){this._initStorage()},connectServer:function(){i.init(this._storage.peerId,{host:a,port:b,path:c}),this._peerListener(),h.start()},connect:function(a){var b=i.get().connect(a);e.$broadcast("BrokerPeerConnection",{connection:b})},connectStream:function(a,b,c){return i.get().call(a,b,{metadata:c})},setPeerId:function(a){j._storage.peerId=a},getPeerId:function(){return i.get().id||""},getPeerIdFromStorage:function(){return this._storage.peerId},_initStorage:function(){var a=d?f:g;this._storage=a.$default({broker:{peerId:""}}).broker},_peerListener:function(){var a=i.get();a.on("open",function(a){j._onOpen(a)}),a.on("call",function(a){j._onCall(a)}),a.on("connection",function(a){j._onConnection(a)}),a.on("error",function(a){j._onError(a)})},_onOpen:function(a){e.$apply(function(){j.setPeerId(a),e.$broadcast("BrokerPeerOpen",{id:a})})},_onCall:function(a){e.$apply(function(){e.$broadcast("BrokerPeerCall",{client:a})})},_onConnection:function(a){e.$apply(function(){e.$broadcast("BrokerPeerConnection",{connection:a})})},_onError:function(a){e.$apply(function(){e.$broadcast("BrokerPeerError",{error:a})})}};return j}]}),angular.module("unchatbar").provider("Profile",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Connection",function(b,c,d,e){return{_storageProfile:{profile:{}},init:function(){this._initStorage(),b.$on("ConnectionOpen",function(a,b){e.send(b.peerId,{action:"profile",profile:this.get()})}.bind(this))},_initStorage:function(){var b=a?c:d;this._storageProfile=b.$default({profile:{}})},get:function(){return _.clone(this._storageProfile.profile)},set:function(a){this._storageProfile.profile=a,this._sendProfileUpdate(),b.$broadcast("profileUpdate")},_sendProfileUpdate:function(){_.forEach(e.getMap(),function(a,b){e.send(b,{action:"profile",profile:this.get()})}.bind(this))}}}]}),angular.module("unchatbar").provider("PhoneBook",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$sessionStorage","$localStorage","Broker",function(b,c,d,e){var f={_storagePhoneBook:{user:{},groups:{}},init:function(){this._initStorage(),b.$on("BrokerPeerConnection",function(a,b){f.addClient(b.connection.peer,{label:b.connection.peer})}),b.$on("BrokerPeerCall",function(a,b){f.addClient(b.client.peer,b.client.metadata.profile)}),b.$on("BrokerPeerOpen",function(){_.forEach(f.getClientMap(),function(a){a.id&&e.connect(a.id)})}),b.$on("ConnectionGetMessageprofile",function(a,b){f.updateClient(b.peerId,b.message.profile.label||"")}),b.$on("ConnectionGetMessageremoveGroup",function(a,b){f.removeGroup(b.message.id)})},_initStorage:function(){var b=a?d:c;this._storagePhoneBook=b.$default({phoneBook:{user:{},groups:{}}}).phoneBook},addClient:function(a,b){this._storagePhoneBook.user[a]||(b.id=a,this._storagePhoneBook.user[a]=b),this._sendUpdateEvent()},updateClient:function(a,b){this._storagePhoneBook.user[a]={label:b||a,id:a},this._sendUpdateEvent()},getClient:function(a){return this._storagePhoneBook.user[a]||""},getClientMap:function(){return this._storagePhoneBook.user},removeClient:function(a){delete this._storagePhoneBook.user[a],this._sendUpdateEvent()},copyGroupFromPartner:function(a,b){b.editable=!1,this._storagePhoneBook.groups[a]=b,this._sendUpdateEvent()},addGroup:function(a,b){var c=e.getPeerId();if(c){var d=this.createNewGroupId();this._storagePhoneBook.groups[d]={label:a,users:b,owner:c,editable:!0,id:d}}this._sendUpdateEvent()},createNewGroupId:function(){return e.getPeerId()+(new Date).getTime()},getGroup:function(a){return this._storagePhoneBook.groups[a]},removeGroup:function(a){delete this._storagePhoneBook.groups[a],this._sendUpdateEvent()},getGroupMap:function(){return this._storagePhoneBook.groups},_sendUpdateEvent:function(){b.$broadcast("PhoneBookUpdate",{})}};return f}]}),angular.module("unchatbar").provider("MessageText",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Broker","PhoneBook","Connection",function(b,c,d,e,f,g){return{_selectedRoom:{},_storageMessages:{messages:{},queue:{}},init:function(){this._initStorage(),b.$on("ConnectionOpen",function(a,b){this._sendFromQueue(b.peerId)}.bind(this)),b.$on("ConnectionGetMessagetextMessage",function(a,b){this._addStoStorage(b.message.group.id||b.peerId,b.peerId,b.message)}.bind(this))},setRoom:function(a,c){this._selectedRoom={},c&&(this._selectedRoom={type:a,id:c}),b.$broadcast("MessageTextSetRoom",{})},isRoomOpen:function(){return this._selectedRoom.id?!0:!1},getMessageList:function(){return this._storageMessages.messages[this._selectedRoom.id]||[]},send:function(a){var b={};this._selectedRoom.type&&("user"===this._selectedRoom.type?b=this._sendToUser(a):"group"===this._selectedRoom.type&&(b=this._sendToGroup(a)),b.own=!0,this._addStoStorage(this._selectedRoom.id,this._selectedRoom.id,b))},sendRemoveGroup:function(a){var b={},c={};f.getGroup(a).owner===e.getPeerId()&&(b=f.getGroup(a).users,c={action:"removeGroup",id:a},_.forEach(b,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)))},_initStorage:function(){var b=a?c:d;this._storageMessages=b.$default({message:{messages:{},queue:{}}}).message},_addStoStorage:function(a,c,d){this._storageMessages.messages[a]||(this._storageMessages.messages[a]=[]),d.group=d.group||{},this._storageMessages.messages[a].push({text:d.text,user:c,group:d.group,own:d.own}),d.group.owner&&d.group.owner===c&&f.copyGroupFromPartner(d.group.id,d.group),b.$broadcast("MessageTextGetMessage")},_sendToUser:function(a){var b={action:"textMessage",from:e.getPeerId(),group:"",text:a};return g.send(this._selectedRoom.id,b)===!1&&this._addToQueue(this._selectedRoom.id,b),b},_sendToGroup:function(a){var b=f.getGroup(this._selectedRoom.id),c={action:"textMessage",from:e.getPeerId(),group:b||{},text:a};return b.owner!==e.getPeerId()&&g.send(b.owner,c)===!1&&this._addToQueue(b.owner,c),_.forEach(b.users,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)),c},_addToQueue:function(a,b){this._storageMessages.queue[a]||(this._storageMessages.queue[a]=[]),this._storageMessages.queue[a].push(b)},_sendFromQueue:function(a){this._storageMessages.queue[a]&&(_.forEach(this._storageMessages.queue[a],function(b,c){g.send(a,b)&&this._storageMessages.queue[a].splice(c)}.bind(this)),0===this._storageMessages.queue[a].length&&delete this._storageMessages.queue[a])}}}]}),angular.module("unchatbar").config(["BrokerProvider","PhoneBookProvider","ProfileProvider","MessageTextProvider","LOCALSTORAGE",function(a,b,c,d,e){e===!0&&(a.setLocalStorage(),c.setLocalStorage(),b.setLocalStorage(),d.setLocalStorage()),a.setHost("unchatbar-server.herokuapp.com"),a.setPort(80)}]),angular.module("unchatbar").config(["$stateProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.state("login",{url:"/login",templateUrl:"views/peer/layout/login.html"}).state("layoutChat",{"abstract":!0,templateUrl:"views/peer/layout/chat/index.html"}).state("chat",{parent:"layoutChat",url:"/chat",views:{header:{templateUrl:"views/peer/layout/chat/header.html"},sidebar:{templateUrl:"views/peer/layout/chat/sidebar.html"},content:{templateUrl:"views/peer/layout/chat/content.html"},footer:{templateUrl:"views/peer/layout/chat/footer.html"}}}).state("chat.user",{url:"/user/{peerId}",parent:"chat"}).state("chat.group",{url:"/group/{groupId}",parent:"chat"}).state("chat.profile",{url:"/profile",parent:"layoutChat",views:{header:{templateUrl:"views/peer/layout/chat/header.html"},sidebar:{templateUrl:"views/peer/layout/chat/sidebar.html"},content:{templateUrl:"views/peer/profile-admin.html"},footer:{templateUrl:"views/peer/layout/chat/footer.html"}}})}]),angular.module("unchatbar").service("Stream",["$rootScope","$q","Broker","Profile",function(a,b,c,d){var e={_stream:{stream:{single:{},conference:{}},ownStream:{}},init:function(){a.$on("BrokerPeerCall",function(a,b){e._onBrokerCall(b.client,b.client.metadata.streamOption)})},callUser:function(a,b){this._createOwnStream(b).then(function(f){e._listenOnClientStreamConnection(c.connectStream(a,f,{profile:d.get(),type:"single",streamOption:b}))})},callConference:function(a,b){this._createOwnStream(b).then(function(f){var g=e.getConferenceClientsMap();e._listenOnClientStreamConnection(c.connectStream(a,f,{profile:d.get(),streamOption:b,type:"conference",conferenceUser:_.keys(g)}))})},getOwnStream:function(a){var b=this._getOwnStreamKeyByOption(a);return this._stream.ownStream[b]||null},getConferenceClientsMap:function(){return this._stream.stream.conference},getConferenceClient:function(a){return this._stream.stream.conference[a]||null},getClientStream:function(a){return this._stream.stream.single[a]},getClientStreamMap:function(){return this._stream.stream.single},_onBrokerCall:function(a,b){this._createOwnStream(b).then(function(b){a.answer(b),e._listenOnClientStreamConnection(a)})},_createOwnStream:function(c){var d=b.defer();return navigator.getUserMedia=this._getUserMediaApi(),0===navigator.getUserMedia?d.reject("no media api"):this.getOwnStream(c)?d.resolve(this.getOwnStream(c)):navigator.getUserMedia(c,function(b){var e=this._getOwnStreamKeyByOption(c);this._stream.ownStream[e]=b,a.$broadcast("StreamAddOwn",{streamOption:c}),d.resolve(b)}.bind(this),function(a){return d.reject(a)}),d.promise},_getOwnStreamKeyByOption:function(a){var b="";return _(a).forEach(function(a,c){b+=c+"_"+a}),b},_getUserMediaApi:function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia},_listenOnClientStreamConnection:function(a){a.on("stream",function(a){"single"===this.metadata.type?e._onStreamSingle(this,a):"conference"===this.metadata.type&&e._onStreamConference(this,a)}),a.on("close",function(){"single"===this.metadata.type?e._onStreamSingleClose(this.peer):"conference"===this.metadata.type&&e._onStreamConferenceClose(this.peer)})},_onStreamSingle:function(b,c){e._stream.stream.single[b.peer]={stream:c,peerId:b.peer,call:b},a.$apply(function(){a.$broadcast("StreamAddClient")})},_onStreamSingleClose:function(b){e._stream.stream.single[b]&&(delete e._stream.stream.single[b],a.$broadcast("StreamDeleteClient"))},_onStreamConference:function(b,c){var d=b.metadata.streamOption,f=b.metadata.conferenceUser||[];_.forEach(f,function(a){null===e.getConferenceClient(a)&&e.callConference(a,d)}),e._stream.stream.conference[b.peer]={stream:c,peerId:b.peer,call:b},a.$apply(function(){a.$broadcast("StreamAddClientToConference")})},_onStreamConferenceClose:function(b){e._stream.stream.conference[b]&&(delete e._stream.stream.conference[b],a.$broadcast("StreamDeleteClientToConference"))}};return e}]),angular.module("unchatbar").controller("broker",["$scope","$state","Broker",function(a,b,c){a.peerId="",a.login=function(){c.setPeerId(a.peerId),c.connectServer(),b.go("chat")}}]),angular.module("unchatbar").controller("phoneBook",["$scope","$stateParams","MessageText","PhoneBook",function(a,b,c,d){a.form={},a.clientMap={},a.groupMap={},a.selectedUser="",a.selectedGroup="",a.getClientAndGroups=function(){a.clientMap=d.getClientMap(),a.groupMap=d.getGroupMap(),a.selectedGroup&&!a.groupMap[a.selectedGroup]&&a.setGroup(""),a.selectedUser&&!a.clientMap[a.selectedUser]&&a.setClient("")},a.setClient=function(b){c.setRoom("user",b),a.selectedGroup="",a.selectedUser=b},a.setGroup=function(b){c.setRoom("group",b),a.selectedGroup=b,a.selectedUser=""},a.createGroup=function(){d.addGroup(a.form.newGroupName,[]),a.form.newGroupName=""},a.init=function(){a.getClientAndGroups(),a.selectedUser=b.peerId||"",a.selectedGroup=b.groupId||"",b.peerId?a.setClient(b.peerId):b.groupId&&a.setGroup(b.groupId)},a.$on("$stateChangeSuccess",function(){a.init()}),a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()})}]),angular.module("unchatbar").controller("phoneBookAdmin",["$scope","$state","$stateParams","$modal","MessageText","PhoneBook","Stream",function(a,b,c,d,e,f,g){a.selectedUser="",a.selectedGroup="",a.clientMap={},a.groupMap={},a.newGroupName="",a.removeClient=function(a){f.removeClient(a),b.go("chat")},a.getClientAndGroups=function(){a.clientMap=f.getClientMap(),a.groupMap=f.getGroupMap(),a.selectedUser=c.peerId||"",a.selectedGroup=c.groupId||""},a.removeGroup=function(a){e.sendRemoveGroup(a),f.removeGroup(a),b.go("chat")},a.getUserName=function(a){return f.getClient(a).label||a},a.streamToClient=function(a){d.open({templateUrl:"views/peer/modal/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){g.callUser(a,b)})},a.streamToConference=function(a){d.open({templateUrl:"views/peer/modal/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){g.callConference(a,b)})},a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()}),a.$on("$stateChangeSuccess",function(){a.selectedUser=c.peerId||"",a.selectedGroup=c.groupId||""})}]),angular.module("unchatbar").controller("dialer",["$scope","Broker",function(a,b){a.peerId=b.getPeerId(),a.connectId="",a.connect=function(){b.connect(a.connectId),a.connectId=""},a.$on("BrokerPeerOpen",function(){a.peerId=b.getPeerId()})}]),angular.module("unchatbar").controller("textMessageList",["$scope","$stateParams","MessageText","PhoneBook","Profile",function(a,b,c,d,e){a.isRoomSelected=!1,a.message="",a.messageList=[],a.send=function(){c.send(a.message),a.messageList=c.getMessageList(),a.message=""},a.getUserName=function(a){return d.getClient(a).label||a},a.init=function(){a.isRoomSelected=b.peerId||b.groupId,a.messageList=c.getMessageList()},a.getProfileName=function(){return e.get().label},a.$on("MessageTextSetRoom",function(){a.init()}),a.$on("MessageTextGetMessage",function(){a.messageList=c.getMessageList()})}]),angular.module("unchatbar").controller("connectionCenter",["$scope",function(a){a.showPanel="",a.setView=function(b){a.showPanel=a.showPanel===b?"":b,a.$broadcast("setView",{name:a.showPanel})}}]),angular.module("unchatbar").controller("profile",["$scope","Profile","Broker",function(a,b,c){a.peerId=c.getPeerId(),a.profile={},a.init=function(){a.profile=b.get()},a.update=function(){b.set(a.profile),a.profile=b.get()},a.$on("profileUpdate",function(){a.init()})}]),angular.module("unchatbar").controller("stream",["$scope","Stream",function(a,b){a.streamMap={},a.streamConferenceMap={},a.$on("StreamAddClient",function(){a.streamMap=b.getClientStreamMap()}),a.$on("StreamDeleteClient",function(){a.streamMap=b.getClientStreamMap()}),a.$on("StreamAddClientToConference",function(){a.streamConferenceMap=b.getConferenceClientsMap()}),a.$on("StreamDeleteClientToConference",function(){a.streamConferenceMap=b.getConferenceClientsMap()})}]),angular.module("unchatbar").controller("modalStreamOption",["$scope","$modalInstance",function(a,b){a.videoCall=function(){b.close({video:!0,audio:!0})},a.audiCall=function(){b.close({video:!1,audio:!0})}}]),angular.module("unchatbar").service("BrokerHeartbeat",["Peer",function(a){return{start:function(){function b(){c=setTimeout(b,2e4),d.socket._wsOpen()&&d.socket.send({type:"HEARTBEAT"})}var c=0,d=a.get();d.socket&&b()}}}]),angular.module("unchatbar").service("Peer",["$window",function(a){var b;return{init:function(c,d){b=new a.Peer(c,d)},get:function(){return b||{}}}}]),angular.module("unchatbar").service("Connection",["$rootScope",function(a){var b={_connectionMap:{},init:function(){a.$on("BrokerPeerConnection",function(a,b){this._add(b.connection)}.bind(this))},send:function(a,b){return this._connectionMap[a]?(this._connectionMap[a].send(b),!0):!1},getMap:function(){return this._connectionMap},_add:function(c){this._connectionMap[c.peer]=c,c.on("open",function(){a.$broadcast("ConnectionOpen",{peerId:this.peer})}),c.on("close",function(){delete b._connectionMap[this.peer]}),c.on("data",function(b){var c=this.peer;a.$apply(function(){a.$broadcast("ConnectionGetMessage"+b.action,{peerId:c,message:b})})})}};return b}]),angular.module("unchatbar").directive("ownStreamVideo",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/stream-video.html",replace:!0,link:function(b,c){b.isVisible=!1,b.$on("StreamAddOwn",function(d,e){b.isVisible=!0,c.prop("src",URL.createObjectURL(a.getOwnStream(e.streamOption)))})}}}]),angular.module("unchatbar").directive("clientStream",["Stream","PhoneBook",function(a,b){return{restrict:"E",templateUrl:"views/peer/stream/client-stream.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(c){function d(){return"conference"===c.type?a.getConferenceClient(c.streamId):"single"===c.type?a.getClientStream(c.streamId):void 0}var e=d().peerId;c.streamType="",c.user=b.getClient(e);var f=d().stream;c.streamType=f.getVideoTracks()[0]?"video":"audio",c.close=function(){var a=d();a&&a.call.close()}}}}]),angular.module("unchatbar").directive("stream",[function(){return{restrict:"E",templateUrl:"views/peer/stream/stream.html",controller:"stream"}}]),angular.module("unchatbar").directive("audioStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/type/audio.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(b,c){"conference"===b.type?c.prop("src",URL.createObjectURL(a.getConferenceClient(b.streamId).stream)):"single"===b.type&&c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("videoStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/type/video.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(b,c){"conference"===b.type?c.prop("src",URL.createObjectURL(a.getConferenceClient(b.streamId).stream)):"single"===b.type&&c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("phoneBookStream",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book-stream.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("phoneBookNewGroup",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/addNewGroup.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar").directive("phoneBook",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("phoneBookAdmin",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book-admin.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar").directive("activeUser",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/active-user.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar").directive("dialer",[function(){return{restrict:"E",templateUrl:"views/peer/dialer.html",controller:"dialer"}}]),angular.module("unchatbar").directive("connectionCenter",[function(){return{restrict:"E",templateUrl:"views/peer/connection-center.html",controller:"connectionCenter"}}]),angular.module("unchatbar").directive("textMessageList",[function(){return{restrict:"E",templateUrl:"views/peer/text-message-list.html",controller:"textMessageList"}}]),angular.module("unchatbar").directive("profile",[function(){return{restrict:"E",templateUrl:"views/peer/profile.html",controller:"profile"}}]),angular.module("unchatbar").run(["$state","Broker","MessageText","PhoneBook","Profile","Connection","Stream",function(a,b,c,d,e,f,g){return c.init(),g.init(),d.init(),e.init(),f.init(),b._initStorage(),b.getPeerIdFromStorage()?(b.connectServer(),void a.go("chat")):(a.go("login"),!1)}]);