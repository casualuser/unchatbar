angular.module("constants",[]).constant("LOCALSTORAGE",!0),angular.module("unchatbar",["constants","cgNotify","ngStorage","ui.bootstrap","angularjs-dropdown-multiselect"]),angular.module("unchatbar").provider("Broker",function(){var a="",b="",c="",d=!1;this.setHost=function(b){a=b},this.setPort=function(a){b=a},this.setPath=function(a){c=a},this.setLocalStorage=function(){d=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","BrokerHeartbeat","Peer",function(e,f,g,h,i){var j={_storage:{peerId:""},connectServer:function(){this._initStorage(),i.init(this._storage.peerId,{host:a,port:b,path:c}),this._peerListener(),h.start()},connect:function(a){var b=i.get().connect(a);e.$broadcast("BrokerPeerConnection",{connection:b})},connectStream:function(a,b,c){return i.get().call(a,b,{metadata:c})},getPeerId:function(){return i.get().id||""},_initStorage:function(){var a=d?f:g;this._storage=a.$default({broker:{peerId:""}}).broker},_peerListener:function(){var a=i.get();a.on("open",function(a){j._onOpen(a)}),a.on("call",function(a){j._onCall(a)}),a.on("connection",function(a){j._onConnection(a)}),a.on("error",function(a){j._onError(a)})},_onOpen:function(a){e.$apply(function(){j._storage.peerId=a,e.$broadcast("BrokerPeerOpen",{id:a})})},_onCall:function(a){e.$apply(function(){e.$broadcast("BrokerPeerCall",{client:a})})},_onConnection:function(a){e.$apply(function(){e.$broadcast("BrokerPeerConnection",{connection:a})})},_onError:function(a){e.$apply(function(){e.$broadcast("BrokerPeerError",{error:a})})}};return j}]}),angular.module("unchatbar").provider("Profile",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Connection",function(b,c,d,e){return{_storageProfile:{profile:{}},init:function(){this._initStorage(),b.$on("ConnectionOpen",function(a,b){e.send(b.peerId,{action:"profile",profile:this.get()})}.bind(this))},_initStorage:function(){var b=a?c:d;this._storageProfile=b.$default({profile:{}})},get:function(){return _.clone(this._storageProfile.profile)},set:function(a){this._storageProfile.profile=a,this._sendProfileUpdate()},_sendProfileUpdate:function(){_.forEach(e.getMap(),function(a,b){e.send(b,{action:"profile",profile:this.get()})}.bind(this))}}}]}),angular.module("unchatbar").provider("PhoneBook",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$sessionStorage","$localStorage","Broker",function(b,c,d,e){var f={_storagePhoneBook:{user:{},groups:{}},init:function(){this._initStorage(),b.$on("BrokerPeerConnection",function(a,b){f.addClient(b.connection.peer,{label:b.connection.peer})}),b.$on("BrokerPeerCall",function(a,b){f.addClient(b.client.peer,b.client.metadata.profile)}),b.$on("BrokerPeerOpen",function(){_.forEach(f.getClientMap(),function(a){a.id&&e.connect(a.id)})}),b.$on("ConnectionGetMessageprofile",function(a,b){f.updateClient(b.peerId,b.message.profile.label||"")}),b.$on("ConnectionGetMessageremoveGroup",function(a,b){f.removeGroup(b.message.id)})},_initStorage:function(){var b=a?d:c;this._storagePhoneBook=b.$default({phoneBook:{user:{},groups:{}}}).phoneBook},addClient:function(a,b){this._storagePhoneBook.user[a]||(b.id=a,this._storagePhoneBook.user[a]=b),this._sendUpdateEvent()},updateClient:function(a,b){this._storagePhoneBook.user[a]={label:b||a,id:a},this._sendUpdateEvent()},getClient:function(a){return this._storagePhoneBook.user[a]||""},getClientMap:function(){return this._storagePhoneBook.user},removeClient:function(a){delete this._storagePhoneBook.user[a],this._sendUpdateEvent()},copyGroupFromPartner:function(a,b){b.editable=!1,this._storagePhoneBook.groups[a]=b,this._sendUpdateEvent()},addGroup:function(a,b){var c=e.getPeerId();if(c){var d=this.createNewGroupId();this._storagePhoneBook.groups[d]={label:a,users:b,owner:c,editable:!0,id:d}}this._sendUpdateEvent()},createNewGroupId:function(){return e.getPeerId()+(new Date).getTime()},getGroup:function(a){return this._storagePhoneBook.groups[a]},removeGroup:function(a){delete this._storagePhoneBook.groups[a],this._sendUpdateEvent()},getGroupMap:function(){return this._storagePhoneBook.groups},_sendUpdateEvent:function(){b.$broadcast("PhoneBookUpdate",{})}};return f}]}),angular.module("unchatbar").provider("MessageText",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Broker","PhoneBook","Connection",function(b,c,d,e,f,g){return{_selectedRoom:{},_storageMessages:{messages:{},queue:{}},init:function(){this._initStorage(),b.$on("ConnectionOpen",function(a,b){this._sendFromQueue(b.peerId)}.bind(this)),b.$on("ConnectionGetMessagetextMessage",function(a,b){this._addStoStorage(b.message.group.id||b.peerId,b.peerId,b.message)}.bind(this))},setRoom:function(a,c){this._selectedRoom={},c&&(this._selectedRoom={type:a,id:c}),b.$broadcast("MessageTextSetRoom",{})},isRoomOpen:function(){return this._selectedRoom.id?!0:!1},getMessageList:function(){return this._storageMessages.messages[this._selectedRoom.id]||[]},send:function(a){var b={};this._selectedRoom.type&&("user"===this._selectedRoom.type?b=this._sendToUser(a):"group"===this._selectedRoom.type&&(b=this._sendToGroup(a)),b.own=!0,this._addStoStorage(this._selectedRoom.id,this._selectedRoom.id,b))},sendRemoveGroup:function(a){var b={},c={};f.getGroup(a).owner===e.getPeerId()&&(b=f.getGroup(a).users,c={action:"removeGroup",id:a},_.forEach(b,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)))},_initStorage:function(){var b=a?c:d;this._storageMessages=b.$default({message:{messages:{},queue:{}}}).message},_addStoStorage:function(a,c,d){this._storageMessages.messages[a]||(this._storageMessages.messages[a]=[]),d.group=d.group||{},this._storageMessages.messages[a].push({text:d.text,user:c,group:d.group,own:d.own}),d.group.owner&&d.group.owner===c&&f.copyGroupFromPartner(d.group.id,d.group),b.$broadcast("MessageTextGetMessage")},_sendToUser:function(a){var b={action:"textMessage",from:e.getPeerId(),group:"",text:a};return g.send(this._selectedRoom.id,b)===!1&&this._addToQueue(this._selectedRoom.id,b),b},_sendToGroup:function(a){var b=f.getGroup(this._selectedRoom.id),c={action:"textMessage",from:e.getPeerId(),group:b||{},text:a};return b.owner!==e.getPeerId()&&g.send(b.owner,c)===!1&&this._addToQueue(b.owner,c),_.forEach(b.users,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)),c},_addToQueue:function(a,b){this._storageMessages.queue[a]||(this._storageMessages.queue[a]=[]),this._storageMessages.queue[a].push(b)},_sendFromQueue:function(a){this._storageMessages.queue[a]&&(_.forEach(this._storageMessages.queue[a],function(b,c){g.send(a,b)&&this._storageMessages.queue[a].splice(c)}.bind(this)),0===this._storageMessages.queue[a].length&&delete this._storageMessages.queue[a])}}}]}),angular.module("unchatbar").config(["BrokerProvider","PhoneBookProvider","ProfileProvider","MessageTextProvider","LOCALSTORAGE",function(a,b,c,d,e){e===!0&&(a.setLocalStorage(),c.setLocalStorage(),b.setLocalStorage(),d.setLocalStorage()),a.setHost("unchatbar-server.herokuapp.com"),a.setPort(80)}]),angular.module("unchatbar").service("Stream",["$rootScope","$q","Broker","Profile",function(a,b,c,d){var e={_stream:{stream:{single:{},conference:{}},ownStream:{}},init:function(){a.$on("BrokerPeerCall",function(a,b){e._onBrokerCall(b.client,b.client.metadata.streamOption)})},callUser:function(a,b){this._createOwnStream(b).then(function(f){e._listenOnClientStreamConnection(c.connectStream(a,f,{profile:d.get(),type:"single",streamOption:b}))})},callConference:function(a,b){this._createOwnStream(b).then(function(f){var g=e.getConferenceClientsMap();e._listenOnClientStreamConnection(c.connectStream(a,f,{profile:d.get(),streamOption:b,type:"conference",conferenceUser:_.keys(g)}))})},getOwnStream:function(a){var b=this._getOwnStreamKeyByOption(a);return this._stream.ownStream[b]||null},getConferenceClientsMap:function(){return this._stream.stream.conference},getConferenceClient:function(a){return this._stream.stream.conference[a]||null},getClientStream:function(a){return this._stream.stream.single[a]},getClientStreamMap:function(){return this._stream.stream.single},_onBrokerCall:function(a,b){this._createOwnStream(b).then(function(b){a.answer(b),e._listenOnClientStreamConnection(a)})},_createOwnStream:function(c){var d=b.defer();return navigator.getUserMedia=this._getUserMediaApi(),0===navigator.getUserMedia?d.reject("no media api"):this.getOwnStream(c)?d.resolve(this.getOwnStream(c)):navigator.getUserMedia(c,function(b){var e=this._getOwnStreamKeyByOption(c);this._stream.ownStream[e]=b,a.$broadcast("StreamAddOwn",{streamOption:c}),d.resolve(b)}.bind(this),function(a){return d.reject(a)}),d.promise},_getOwnStreamKeyByOption:function(a){var b="";return _(a).forEach(function(a,c){b+=c+"_"+a}),b},_getUserMediaApi:function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia},_listenOnClientStreamConnection:function(a){a.on("stream",function(a){"single"===this.metadata.type?e._onStreamSingle(this,a):"conference"===this.metadata.type&&e._onStreamConference(this,a)}),a.on("close",function(){"single"===this.metadata.type?e._onStreamSingleClose(this.peer):"conference"===this.metadata.type&&e._onStreamConferenceClose(this.peer)})},_onStreamSingle:function(b,c){e._stream.stream.single[b.peer]={stream:c,peerId:b.peer,call:b},a.$apply(function(){a.$broadcast("StreamAddClient")})},_onStreamSingleClose:function(b){e._stream.stream.single[b]&&(delete e._stream.stream.single[b],a.$broadcast("StreamDeleteClient"))},_onStreamConference:function(b,c){var d=b.metadata.streamOption,f=b.metadata.conferenceUser||[];_.forEach(f,function(a){null===e.getConferenceClient(a)&&e.callConference(a,d)}),e._stream.stream.conference[b.peer]={stream:c,peerId:b.peer,call:b},a.$apply(function(){a.$broadcast("StreamAddClientToConference")})},_onStreamConferenceClose:function(b){e._stream.stream.conference[b]&&(delete e._stream.stream.conference[b],a.$broadcast("StreamDeleteClientToConference"))}};return e}]),angular.module("unchatbar").controller("phoneBook",["$scope","$modal","MessageText","PhoneBook","Stream",function(a,b,c,d,e){a.clientMap={},a.groupMap={},a.selectedUser="",a.selectedGroup="",a.getClientAndGroups=function(){a.clientMap=d.getClientMap(),a.groupMap=d.getGroupMap(),a.selectedGroup&&!a.groupMap[a.selectedGroup]&&a.setGroup(""),a.selectedUser&&!a.clientMap[a.selectedUser]&&a.setClient("")},a.streamToClient=function(a){b.open({templateUrl:"views/peer/modal/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){e.callUser(a,b)})},a.streamToConference=function(a){b.open({templateUrl:"views/peer/modal/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){e.callConference(a,b)})},a.setClient=function(b){c.setRoom("user",b),a.selectedGroup="",a.selectedUser=b},a.setGroup=function(b){c.setRoom("group",b),a.selectedGroup=b,a.selectedUser=""},a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()})}]),angular.module("unchatbar").controller("phoneBookAdmin",["$scope","MessageText","PhoneBook",function(a,b,c){a.clientList={},a.groupList={},a.newGroupName="",a.removeClient=function(a){c.removeClient(a)},a.getClientAndGroups=function(){a.clientList=c.getClientMap(),a.groupList=c.getGroupMap()},a.createGroup=function(){c.addGroup(a.newGroupName,[]),a.newGroupName=""},a.removeGroup=function(a){b.sendRemoveGroup(a),c.removeGroup(a)},a.getUserName=function(a){return c.getClient(a).label||a},a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()})}]),angular.module("unchatbar").controller("dialer",["$scope","Broker",function(a,b){a.peerId=b.getPeerId(),a.connectId="",a.connect=function(){b.connect(a.connectId),a.connectId=""},a.$on("BrokerPeerOpen",function(){a.peerId=b.getPeerId()})}]),angular.module("unchatbar").controller("textMessageList",["$scope","MessageText","PhoneBook","Profile",function(a,b,c,d){a.isOpen=!1,a.isRoomSelected=!1,a.message="",a.messageList=[],a.send=function(){b.send(a.message),a.messageList=b.getMessageList(),a.message=""},a.getUserName=function(a){return c.getClient(a).label||a},a.getProfileName=function(){return d.get().label},a.$on("MessageTextGetMessage",function(){a.isOpen&&(a.messageList=b.getMessageList())}),a.$on("MessageTextSetRoom",function(){a.isRoomSelected=b.isRoomOpen(),a.messageList=b.getMessageList()}),a.$on("setView",function(b,c){a.isOpen="chat"===c.name})}]),angular.module("unchatbar").controller("connectionCenter",["$scope",function(a){a.showPanel="",a.setView=function(b){a.showPanel=a.showPanel===b?"":b,a.$broadcast("setView",{name:a.showPanel})}}]),angular.module("unchatbar").controller("profile",["$scope","Profile","Broker",function(a,b,c){a.peerId=c.getPeerId(),a.profile={},a.showName=!1,a.init=function(){a.showName=!1,a.profile=b.get()},a.update=function(){a.showName=!1,b.set(a.profile),a.profile=b.get()}}]),angular.module("unchatbar").controller("stream",["$scope","Stream",function(a,b){a.streamMap={},a.streamConferenceMap={},a.$on("StreamAddClient",function(){a.streamMap=b.getClientStreamMap()}),a.$on("StreamDeleteClient",function(){a.streamMap=b.getClientStreamMap()}),a.$on("StreamAddClientToConference",function(){a.streamConferenceMap=b.getConferenceClientsMap()}),a.$on("StreamDeleteClientToConference",function(){a.streamConferenceMap=b.getConferenceClientsMap()})}]),angular.module("unchatbar").controller("modalStreamOption",["$scope","$modalInstance",function(a,b){a.videoCall=function(){b.close({video:!0,audio:!0})},a.audiCall=function(){b.close({video:!1,audio:!0})}}]),angular.module("unchatbar").service("BrokerHeartbeat",["Peer",function(a){return{start:function(){function b(){c=setTimeout(b,2e4),d.socket._wsOpen()&&d.socket.send({type:"HEARTBEAT"})}var c=0,d=a.get();d.socket&&b()}}}]),angular.module("unchatbar").service("Peer",["$window",function(a){var b;return{init:function(c,d){b=new a.Peer(c,d)},get:function(){return b||{}}}}]),angular.module("unchatbar").service("Connection",["$rootScope",function(a){var b={_connectionMap:{},init:function(){a.$on("BrokerPeerConnection",function(a,b){this._add(b.connection)}.bind(this))},send:function(a,b){return this._connectionMap[a]?(this._connectionMap[a].send(b),!0):!1},getMap:function(){return this._connectionMap},_add:function(c){this._connectionMap[c.peer]=c,c.on("open",function(){a.$broadcast("ConnectionOpen",{peerId:c.peer})}),c.on("close",function(){delete b._connectionMap[this.peer]}),c.on("data",function(b){var c=this.peer;a.$apply(function(){a.$broadcast("ConnectionGetMessage"+b.action,{peerId:c,message:b})})})}};return b}]),angular.module("unchatbar").directive("ownStreamVideo",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/stream-video.html",replace:!0,link:function(b,c){b.isVisible=!1,b.$on("StreamAddOwn",function(d,e){b.isVisible=!0,c.prop("src",URL.createObjectURL(a.getOwnStream(e.streamOption)))})}}}]),angular.module("unchatbar").directive("clientStream",["Stream","PhoneBook",function(a,b){return{restrict:"E",templateUrl:"views/peer/stream/client-stream.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(c){function d(){return"conference"===c.type?a.getConferenceClient(c.streamId):"single"===c.type?a.getClientStream(c.streamId):void 0}var e=d().peerId;c.streamType="",c.user=b.getClient(e);var f=d().stream;c.streamType=f.getVideoTracks()[0]?"video":"audio",c.close=function(){var a=d();a&&a.call.close()}}}}]),angular.module("unchatbar").directive("stream",[function(){return{restrict:"E",templateUrl:"views/peer/stream/stream.html",controller:"stream"}}]),angular.module("unchatbar").directive("audioStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/type/audio.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(b,c){"conference"===b.type?c.prop("src",URL.createObjectURL(a.getConferenceClient(b.streamId).stream)):"single"===b.type&&c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("videoStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/type/video.html",replace:!0,scope:{streamId:"@",type:"@"},link:function(b,c){"conference"===b.type?c.prop("src",URL.createObjectURL(a.getConferenceClient(b.streamId).stream)):"single"===b.type&&c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("phoneBookStream",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book-stream.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("phoneBook",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("phoneBookAdmin",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phoneBook/book-admin.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar").directive("dialer",[function(){return{restrict:"E",templateUrl:"views/peer/dialer.html",controller:"dialer"}}]),angular.module("unchatbar").directive("connectionCenter",[function(){return{restrict:"E",templateUrl:"views/peer/connection-center.html",controller:"connectionCenter"}}]),angular.module("unchatbar").directive("textMessageList",[function(){return{restrict:"E",templateUrl:"views/peer/text-message-list.html",controller:"textMessageList"}}]),angular.module("unchatbar").directive("profile",[function(){return{restrict:"E",templateUrl:"views/peer/profile.html",controller:"profile"}}]),angular.module("unchatbar").run(["Broker","MessageText","PhoneBook","Profile","Connection","Stream",function(a,b,c,d,e,f){b.init(),f.init(),c.init(),d.init(),e.init(),a.connectServer()}]);