angular.module("constants",[]).constant("LOCALSTORAGE",!0),angular.module("unchatbar",["constants","cgNotify","ngStorage","ui.bootstrap","angularjs-dropdown-multiselect"]),angular.module("unchatbar").provider("Broker",function(){var a="",b="",c="",d=!1;this.setHost=function(b){a=b},this.setPort=function(a){b=a},this.setPath=function(a){c=a},this.setLocalStorage=function(){d=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","BrokerHeartbeat","Peer",function(e,f,g,h,i){return{_storage:{peerId:""},connectServer:function(){this._initStorage(),i.init(this._storage.peerId,{host:a,port:b,path:c}),this._peerListener(),h.start()},connect:function(a){var b=i.get().connect(a);e.$broadcast("client:connect",{connection:b})},connectStream:function(a,b,c){return i.get().call(a,b,{metadata:c})},getPeerId:function(){return i.get().id||""},_initStorage:function(){var a=d?f:g;this._storage=a.$default({broker:{peerId:""}}).broker},_peerListener:function(){var a=i.get();a.on("open",function(a){e.$apply(function(){this._storage.peerId=a,e.$broadcast("peer:open",{id:a})}.bind(this))}.bind(this)),a.on("call",function(a){e.$apply(function(){e.$broadcast("peer:call",{client:a})}.bind(this))}.bind(this)),a.on("stream",function(a){e.$apply(function(){e.$broadcast("peer:addStream",{stream:a})}.bind(this))}.bind(this)),a.on("connection",function(a){e.$apply(function(){e.$broadcast("client:connect",{connection:a})})}),a.on("error",function(a){e.$apply(function(){e.$broadcast("peer:error",{error:a})})})}}}]}),angular.module("unchatbar").provider("Profile",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Connection",function(b,c,d,e){return{_storageProfile:{profile:{}},init:function(){this._initStorage(),b.$on("connection:open",function(a,b){e.send(b.peerId,{action:"profile",profile:this.get()})}.bind(this))},_initStorage:function(){var b=a?c:d;this._storageProfile=b.$default({profile:{}})},get:function(){return _.clone(this._storageProfile.profile)},set:function(a){this._storageProfile.profile=a,this._sendProfileUpdate()},_sendProfileUpdate:function(){_.forEach(e.getMap(),function(a,b){e.send(b,{action:"profile",profile:this.get()})}.bind(this))}}}]}),angular.module("unchatbar").provider("PhoneBook",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$sessionStorage","$localStorage","Broker",function(b,c,d,e){return{_storagePhoneBook:{user:{},groups:{}},init:function(){this._initStorage(),b.$on("client:connect",function(a,b){var c=this.getClientMap();c[b.connection.peer]||this.addClient(b.connection.peer,b.connection.peer)}.bind(this)),b.$on("peer:open",function(){_.forEach(this.getClientMap(),function(a){a.id&&e.connect(a.id)}.bind(this))}.bind(this)),b.$on("connection:getMessage:profile",function(a,b){this.updateClient(b.peerId,b.message.profile.label||"")}.bind(this)),b.$on("connection:getMessage:removeGroup",function(a,b){this.removeGroup(b.message.id)}.bind(this))},_initStorage:function(){var b=a?d:c;this._storagePhoneBook=b.$default({phoneBook:{user:{},groups:{}}}).phoneBook},addClient:function(a,b){this._storagePhoneBook.user[a]={label:b,id:a},this._sendUpdateEvent()},updateClient:function(a,b){this._storagePhoneBook.user[a]={label:b||a,id:a},this._sendUpdateEvent()},getClient:function(a){return this._storagePhoneBook.user[a]||""},getClientMap:function(){return this._storagePhoneBook.user},removeClient:function(a){delete this._storagePhoneBook.user[a],this._sendUpdateEvent()},copyGroupFromPartner:function(a,b){b.editable=!1,this._storagePhoneBook.groups[a]=b,this._sendUpdateEvent()},addGroup:function(a,b){var c=e.getPeerId();if(c){var d=this.createNewGroupId();this._storagePhoneBook.groups[d]={label:a,users:b,owner:c,editable:!0,id:d}}this._sendUpdateEvent()},createNewGroupId:function(){return e.getPeerId()+(new Date).getTime()},getGroup:function(a){return this._storagePhoneBook.groups[a]},removeGroup:function(a){delete this._storagePhoneBook.groups[a],this._sendUpdateEvent()},getGroupMap:function(){return this._storagePhoneBook.groups},_sendUpdateEvent:function(){b.$broadcast("phonebook:update",{})}}}]}),angular.module("unchatbar").provider("MessageText",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$localStorage","$sessionStorage","Broker","PhoneBook","Connection",function(b,c,d,e,f,g){return{_selectedRoom:{},_storageMessages:{messages:{},queue:{}},init:function(){this._initStorage(),b.$on("connection:open",function(a,b){this._sendFromQueue(b.peerId)}.bind(this)),b.$on("connection:getMessage:textMessage",function(a,b){this._addStoStorage(b.message.group.id||b.peerId,b.peerId,b.message)}.bind(this))},_initStorage:function(){var b=a?c:d;this._storageMessages=b.$default({message:{messages:{},queue:{}}}).message},setRoom:function(a,c){this._selectedRoom={},c&&(this._selectedRoom={type:a,id:c}),b.$broadcast("chat:setRoom",{})},isRoomOpen:function(){return this._selectedRoom.id?!0:!1},getMessageList:function(){return this._storageMessages.messages[this._selectedRoom.id]||[]},send:function(a){var b={};this._selectedRoom.type&&("user"===this._selectedRoom.type?b=this._sendToUser(a):"group"===this._selectedRoom.type&&(b=this._sendToGroup(a)),b.own=!0,this._addStoStorage(this._selectedRoom.id,this._selectedRoom.id,b))},sendRemoveGroup:function(a){var b={},c={};f.getGroup(a).owner===e.getPeerId()&&(b=f.getGroup(a).users,c={action:"removeGroup",id:a},_.forEach(b,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)))},_addStoStorage:function(a,c,d){this._storageMessages.messages[a]||(this._storageMessages.messages[a]=[]),d.group=d.group||{},this._storageMessages.messages[a].push({text:d.text,user:c,group:d.group,own:d.own}),d.group.owner&&d.group.owner===c&&f.copyGroupFromPartner(d.group.id,d.group),b.$broadcast("chat:getMessage")},_sendToUser:function(a){var b={action:"textMessage",from:e.getPeerId(),group:"",text:a};return g.send(this._selectedRoom.id,b)===!1&&this._addToQueue(this._selectedRoom.id,b),b},_sendToGroup:function(a){var b=f.getGroup(this._selectedRoom.id),c={action:"textMessage",from:e.getPeerId(),group:b||{},text:a};return b.owner!==e.getPeerId()&&g.send(b.owner,c)===!1&&this._addToQueue(b.owner,c),_.forEach(b.users,function(a){g.send(a.id,c)===!1&&this._addToQueue(a.id,c)}.bind(this)),c},_addToQueue:function(a,b){this._storageMessages.queue[a]||(this._storageMessages.queue[a]=[]),this._storageMessages.queue[a].push(b)},_sendFromQueue:function(a){this._storageMessages.queue[a]&&(_.forEach(this._storageMessages.queue[a],function(b,c){g.send(a,b)&&this._storageMessages.queue[a].splice(c)}.bind(this)),0===this._storageMessages.queue[a].length&&delete this._storageMessages.queue[a])}}}]}),angular.module("unchatbar").config(["BrokerProvider","PhoneBookProvider","ProfileProvider","MessageTextProvider","LOCALSTORAGE",function(a,b,c,d,e){e===!0&&(a.setLocalStorage(),c.setLocalStorage(),b.setLocalStorage(),d.setLocalStorage()),a.setHost("unchatbar-server.herokuapp.com"),a.setPort(80)}]),angular.module("unchatbar").service("Stream",["$rootScope","$q","Broker",function(a,b,c){var d={_stream:{stream:{},ownStream:{}},init:function(){a.$on("peer:call",function(a,b){var c=b.client.metadata.streamOption;null!==this.getOwnStream(c)?b.client.answer(this.getOwnStream(c)):this._createOwnStream(c).then(function(a){b.client.answer(a)}),this._listenOnClientAnswer(b.client)}.bind(this))},callUser:function(a,b){null===this.getOwnStream(b)?this._createOwnStream(b).then(function(d){this._listenOnClientAnswer(c.connectStream(a,d,{streamOption:b}))}.bind(this)):this._listenOnClientAnswer(c.connectStream(a,this.getOwnStream(b),{streamOption:b}))},getOwnStream:function(a){var b=this._getOwnStreamKeyByOption(a);return this._stream.ownStream[b]||null},_getOwnStreamKeyByOption:function(a){var b="";return _(a).forEach(function(a,c){b+=c+"_"+a}),b},getClientStream:function(a){return this._stream.stream[a]},getClientStreamMap:function(){return this._stream.stream},_listenOnClientAnswer:function(b){b.on("stream",function(b){d._stream.stream[this.peer]={stream:b,peerId:this.peer,call:this},a.$apply(function(){a.$broadcast("stream:add")})}),b.on("close",function(){d._stream.stream[this.peer]&&delete d._stream.stream[this.peer],a.$broadcast("stream:delete")})},_createOwnStream:function(c){var d=b.defer();return navigator.getUserMedia=this._getUserMediaApi(),0===navigator.getUserMedia?d.reject("no media api"):navigator.getUserMedia(c,function(b){var e=this._getOwnStreamKeyByOption(c);this._stream.ownStream[e]=b,a.$broadcast("stream:addOwn",{streamOption:c}),d.resolve(b)}.bind(this),function(a){return d.reject(a)}),d.promise},_getUserMediaApi:function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}};return d}]),angular.module("unchatbar").controller("phoneBook",["$scope","$modal","MessageText","PhoneBook","Stream",function(a,b,c,d,e){a.clientMap={},a.groupMap={},a.selectedUser="",a.selectedGroup="",a.getClientAndGroups=function(){a.clientMap=d.getClientMap(),a.groupMap=d.getGroupMap(),a.selectedGroup&&!a.groupMap[a.selectedGroup]&&a.setGroup(""),a.selectedUser&&!a.clientMap[a.selectedUser]&&a.setClient("")},a.streamToClient=function(a){b.open({templateUrl:"views/peer/modal/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){e.callUser(a,b)})},a.setClient=function(b){c.setRoom("user",b),a.selectedGroup="",a.selectedUser=b},a.setGroup=function(b){c.setRoom("group",b),a.selectedGroup=b,a.selectedUser=""},a.$on("phonebook:update",function(){a.getClientAndGroups()})}]),angular.module("unchatbar").controller("phoneBookAdmin",["$scope","MessageText","PhoneBook",function(a,b,c){a.clientList={},a.groupList={},a.newGroupName="",a.removeClient=function(a){c.removeClient(a)},a.getClientAndGroups=function(){a.clientList=c.getClientMap(),a.groupList=c.getGroupMap()},a.createGroup=function(){c.addGroup(a.newGroupName,[]),a.newGroupName=""},a.removeGroup=function(a){b.sendRemoveGroup(a),c.removeGroup(a)},a.getUserName=function(a){return c.getClient(a).label||a},a.$on("phonebook:update",function(){a.getClientAndGroups()})}]),angular.module("unchatbar").controller("dialer",["$scope","Broker",function(a,b){a.peerId=b.getPeerId(),a.connectId="",a.connect=function(){b.connect(a.connectId),a.connectId=""},a.$on("peer:open",function(){a.peerId=b.getPeerId()})}]),angular.module("unchatbar").controller("textMessageList",["$scope","MessageText","PhoneBook","Profile",function(a,b,c,d){a.isOpen=!1,a.isRoomSelected=!1,a.message="",a.messageList=[],a.send=function(){b.send(a.message),a.messageList=b.getMessageList(),a.message=""},a.getUserName=function(a){return c.getClient(a).label||a},a.getProfileName=function(){return d.get().label},a.$on("chat:getMessage",function(){a.isOpen&&(a.messageList=b.getMessageList())}),a.$on("chat:setRoom",function(){a.isRoomSelected=b.isRoomOpen(),a.messageList=b.getMessageList()}),a.$on("setView",function(b,c){a.isOpen="chat"===c.name})}]),angular.module("unchatbar").controller("connectionCenter",["$scope",function(a){a.showPanel="",a.setView=function(b){a.showPanel=a.showPanel===b?"":b,a.$broadcast("setView",{name:a.showPanel})}}]),angular.module("unchatbar").controller("profile",["$scope","Profile","Broker",function(a,b,c){a.peerId=c.getPeerId(),a.profile={},a.showName=!1,a.init=function(){a.showName=!1,a.profile=b.get()},a.update=function(){a.showName=!1,b.set(a.profile),a.profile=b.get()}}]),angular.module("unchatbar").controller("stream",["$scope","Stream",function(a,b){a.streamMap={},a.$on("stream:add",function(){a.streamMap=b.getClientStreamMap()}),a.$on("stream:delete",function(){a.streamMap=b.getClientStreamMap()})}]),angular.module("unchatbar").controller("modalStreamOption",["$scope","$modalInstance",function(a,b){a.videoCall=function(){b.close({video:!0,audio:!0})},a.audiCall=function(){b.close({video:!1,audio:!0})}}]),angular.module("unchatbar").service("BrokerHeartbeat",["Peer",function(a){return{start:function(){function b(){c=setTimeout(b,2e4),d.socket._wsOpen()&&d.socket.send({type:"HEARTBEAT"})}var c=0,d=a.get();d.socket&&b()}}}]),angular.module("unchatbar").service("Peer",["$window",function(a){var b;return{init:function(c,d){b=new a.Peer(c,d)},get:function(){return b||{}}}}]),angular.module("unchatbar").service("Connection",["$rootScope",function(a){return{_connectionMap:{},init:function(){a.$on("client:connect",function(a,b){this._add(b.connection)}.bind(this))},send:function(a,b){return this._connectionMap[a]?(this._connectionMap[a].send(b),!0):!1},getMap:function(){return this._connectionMap},_add:function(b){this._connectionMap[b.peer]=b,b.on("open",function(){a.$broadcast("connection:open",{peerId:b.peer})}),b.on("close",function(){delete this._connectionMap[b.peer]}.bind(this)),b.on("data",function(c){a.$apply(function(){a.$broadcast("connection:getMessage:"+c.action,{peerId:b.peer,message:c})})})}}}]),angular.module("unchatbar").directive("stream",[function(){return{restrict:"E",templateUrl:"views/peer/stream.html",controller:"stream"}}]),angular.module("unchatbar").directive("audioStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/audio.html",replace:!0,scope:{streamId:"@"},link:function(b,c){c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("videoStream",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream/video.html",replace:!0,scope:{streamId:"@"},link:function(b,c){c.prop("src",URL.createObjectURL(a.getClientStream(b.streamId).stream))}}}]),angular.module("unchatbar").directive("ownStreamVideo",["Stream",function(a){return{restrict:"E",templateUrl:"views/peer/stream-video.html",replace:!0,link:function(b,c){b.isVisible=!1,b.$on("stream:addOwn",function(d,e){b.isVisible=!0,c.prop("src",URL.createObjectURL(a.getOwnStream(e.streamOption)))})}}}]),angular.module("unchatbar").directive("clientStream",["Stream","PhoneBook",function(a,b){return{restrict:"E",templateUrl:"views/peer/client-stream.html",replace:!0,scope:{streamId:"@"},link:function(c){c.close=function(){var b=a.getClientStream(c.streamId);b&&b.call.close()},c.streamType="";var d=a.getClientStream(c.streamId).peerId;c.user=b.getClient(d);var e=a.getClientStream(c.streamId).stream;c.streamType=e.getVideoTracks()[0]?"video":"audio"}}}]),angular.module("unchatbar").directive("phoneBookStream",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phone-book-stream.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("dialer",[function(){return{restrict:"E",templateUrl:"views/peer/dialer.html",controller:"dialer"}}]),angular.module("unchatbar").directive("connectionCenter",[function(){return{restrict:"E",templateUrl:"views/peer/connection-center.html",controller:"connectionCenter"}}]),angular.module("unchatbar").directive("textMessageList",[function(){return{restrict:"E",templateUrl:"views/peer/text-message-list.html",controller:"textMessageList"}}]),angular.module("unchatbar").directive("phoneBook",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phone-book.html",controller:"phoneBook"}}]),angular.module("unchatbar").directive("phoneBookAdmin",[function(){return{restrict:"E",replace:!0,templateUrl:"views/peer/phone-book-admin.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar").directive("profile",[function(){return{restrict:"E",templateUrl:"views/peer/profile.html",controller:"profile"}}]),angular.module("unchatbar").run(["Broker","MessageText","PhoneBook","Profile","Connection","Stream",function(a,b,c,d,e,f){b.init(),f.init(),c.init(),d.init(),e.init(),a.connectServer()}]);